<p-confirmDialog></p-confirmDialog>
<form [formGroup]="itemForm" (ngSubmit)="save()">
  <div class="form-content p-fluid">

    <div class="field">
      <label for="name">Name</label>
      <input id="name" type="text" pInputText formControlName="name" />
      @if(itemForm.get('name').invalid && itemForm.get('name').touched) {
        <small class="p-error">Name is required.</small>
      }
    </div>

    <div class="field">
      <label for="description">Description</label>
      <textarea id="description" pInputTextarea formControlName="description" rows="4" [autoResize]="true"></textarea>
    </div>

    <div formGroupName="properties">

      <div *ngIf="item.type === 'WEAPON'">
        <h4 class="properties-header">Weapon Properties</h4>
        <div class="p-grid p-fluid">
          <div class="p-col-12 p-md-6 field">
            <label for="damage_dice">Damage Dice</label>
            <input id="damage_dice" type="text" pInputText formControlName="damage_dice" placeholder="e.g., 2d6" />
          </div>
          <div class="p-col-12 p-md-6 field">
            <label for="damage_type">Damage Type</label>
            <p-dropdown
              inputId="damage_type"
              [options]="damageTypes"
              formControlName="damage_type"
              placeholder="Select a type">
            </p-dropdown>
          </div>
          <div class="p-col-12 p-md-6 field">
            <label for="attack_stat">Attack Stat</label>
            <p-dropdown
              inputId="attack_stat"
              [options]="attackStatTypes"
              formControlName="attack_stat"
              placeholder="Select a stat">
            </p-dropdown>
          </div>
          <div class="p-col-12 p-md-6 field flex align-items-center">
            <p-checkbox
              formControlName="proficient"
              [binary]="true"
              inputId="proficient_checkbox">
            </p-checkbox>
            <label for="proficient_checkbox" class="ml-2">Proficient</label>
          </div>
        </div>
      </div>

      <div formGroupName="action_template">
        <h5 class="properties-header sub-header">Effects</h5>

        <div class="field">
          <label for="outputString">Output Template</label>
          <textarea id="outputString" pInputTextarea formControlName="outputString" rows="3" [autoResize]="true"></textarea>
          <small class="p-text-muted">
            Use placeholders like {{ '{' }}name{{ '}' }}, {{ '{' }}damage_dice{{ '}' }}, {{ '{' }}attack_roll{{ '}' }}.
            You can also define custom placeholders in the effects below.
          </small>
        </div>

        <div class="field">
          <label>Live Preview</label>
          <div class="preview-box">
            {{ previewString }}
          </div>
        </div>

        <div cdkDropList [cdkDropListData]="effects.controls" (cdkDropListDropped)="drop($event)" class="effects-list">
          @for (effect of effects.controls; track i; let i = $index) {
            <div cdkDrag class="effect-card p-4 mb-3">
              <div class="effect-header">
                <i class="pi pi-bars drag-handle" cdkDragHandle></i>
                <h6 class="effect-title">Effect #{{ i + 1 }}</h6>
                <button pButton pRipple type="button" icon="pi pi-trash" class="p-button-rounded p-button-danger p-button-text" (click)="removeEffect(i)"></button>
              </div>
              <div [formGroupName]="i">
                <div class="p-grid">
                  <div class="p-col-12 field">
                    <label for="effect-name-{{i}}">Effect Name</label>
                    <input id="effect-name-{{i}}" type="text" pInputText formControlName="name">
                  </div>
                  <div class="p-col-12 p-md-6 field">
                    <label for="effect-type-{{i}}">Effect Type</label>
                    <p-dropdown inputId="effect-type-{{i}}" [options]="effectTypes" formControlName="type"></p-dropdown>
                  </div>
                  <div class="p-col-12 p-md-6 field">
                    <label for="apply-to-{{i}}">Apply To</label>
                    <p-dropdown inputId="apply-to-{{i}}" [options]="applyToTypes" formControlName="applyTo"></p-dropdown>
                  </div>
                  <div class="p-col-12 field">
                    <label for="value-{{i}}">Value</label>
                    <input id="value-{{i}}" type="text" pInputText formControlName="value" placeholder="e.g., +2, 1d6">
                  </div>
                  <div class="p-col-12 p-md-6 field" *ngIf="effect.get('type').value === 'DAMAGE'">
                    <label for="damage-type-{{i}}">Damage Type</label>
                    <p-dropdown inputId="damage-type-{{i}}" [options]="damageTypes" formControlName="damageType"></p-dropdown>
                  </div>
                  <div class="p-col-12 p-md-6 field" *ngIf="effect.get('type').value === 'MODIFIER'">
                    <label for="stat-{{i}}">Stat to Buff</label>
                    <p-dropdown inputId="stat-{{i}}" [options]="statsToBuff" formControlName="stat"></p-dropdown>
                  </div>
                  <div class="p-col-12 field">
                    <label for="condition-{{i}}">Condition</label>
                    <p-dropdown inputId="condition-{{i}}" [options]="conditionTypes" formControlName="condition" [showClear]="true" placeholder="Optional condition"></p-dropdown>
                  </div>
                </div>
              </div>
            </div>
          }
        </div>
        <button pButton pRipple type="button" label="Add Effect" icon="pi pi-plus" (click)="addEffect()" class="p-button-outlined mt-3"></button>

      </div>

    </div>
  </div>
</form>

<div class="p-dialog-footer">
  <button pButton type="button" label="Delete" class="p-button-danger" (click)="delete()"></button>
  <button pButton type="button" label="Cancel" class="p-button-text" (click)="close()"></button>
  <button pButton type="button" label="Save" class="p-button-success" (click)="save()" [disabled]="itemForm.invalid"></button>
</div>
