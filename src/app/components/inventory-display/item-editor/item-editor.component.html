<p-confirmDialog></p-confirmDialog>
<form [formGroup]="itemForm" (ngSubmit)="save()">
  <div class="form-content p-fluid">

    <div class="field">
      <label for="name">Name</label>
      <input id="name" type="text" pInputText formControlName="name" />
      @if(itemForm.get('name').invalid && itemForm.get('name').touched) {
        <small class="p-error">Name is required.</small>
      }
    </div>

    <div class="field">
      <label for="description">Description</label>
      <textarea id="description" pInputTextarea formControlName="description" rows="4" [autoResize]="true"></textarea>
    </div>

    <div formGroupName="properties">

      <div *ngIf="item.type === 'WEAPON'">
        <h4 class="properties-header">Weapon Properties</h4>
        <div class="p-grid p-fluid">
          <div class="p-col-12 p-md-6 field">
            <label for="damage_dice">Damage Dice</label>
            <input id="damage_dice" type="text" pInputText formControlName="damage_dice" placeholder="e.g., 2d6" />
          </div>
          <div class="p-col-12 p-md-6 field">
            <label for="damage_type">Damage Type</label>
            <p-dropdown
              id="damage_type"
              [options]="damageTypes"
              formControlName="damage_type"
              placeholder="Select a type">
            </p-dropdown>
          </div>
          <div class="p-col-12 p-md-6 field">
            <label for="attack_stat">Attack Stat</label>
            <p-dropdown
              id="attack_stat"
              [options]="attackStatTypes"
              formControlName="attack_stat"
              placeholder="Select a stat">
            </p-dropdown>
          </div>
          <div class="p-col-12 p-md-6 field flex align-items-center">
            <p-checkbox
              formControlName="proficient"
              [binary]="true"
              inputId="proficient_checkbox">
            </p-checkbox>
            <label for="proficient_checkbox" class="ml-2">Proficient</label>
          </div>
        </div>
      </div>

      <div formGroupName="action_template">
        <h5 class="properties-header sub-header">Effects</h5>

        <div class="field">
          <label for="outputString">Output Template</label>
          <textarea id="outputString" pInputTextarea formControlName="outputString" rows="3" [autoResize]="true"
                    pTooltip="Define how the roll is displayed. Use placeholders like {name}, {attack}, {damage}."></textarea>
        </div>

        <div formArrayName="effects">
          @for(effectControl of effects.controls; track i; let i = $index) {
            <div [formGroupName]="i" class="effect-group p-card p-3 mb-3">
              <div class="grid p-fluid">
                <!-- Row 1: Name and Type -->
                <div class="col-12 md:col-4 field">
                  <label [for]="'effect-name-' + i">Effect Name</label>
                  <input [id]="'effect-name-' + i" pInputText formControlName="name" />
                </div>
                <div class="col-12 md:col-4 field">
                  <label [for]="'effect-type-' + i">Effect Type</label>
                  <p-dropdown [id]="'effect-type-' + i" [options]="effectTypes" formControlName="type"></p-dropdown>
                </div>
                <div class="col-12 md:col-4 field">
                  <label [for]="'effect-applyTo-' + i">Apply To</label>
                  <p-dropdown [id]="'effect-applyTo-' + i" [options]="applyToTypes" formControlName="applyTo"></p-dropdown>
                </div>

                <!-- Row 2: Value, Damage Type, Stat (Conditional) -->
                <div class="col-12 md:col-4 field">
                  <label [for]="'effect-value-' + i">Value</label>
                  <input [id]="'effect-value-' + i" pInputText formControlName="value" placeholder="e.g., 1d6 or +2"/>
                </div>

                <div class="col-12 md:col-4 field" *ngIf="effectControl.get('type').value === 'DAMAGE'">
                  <label [for]="'effect-damageType-' + i">Damage Type</label>
                  <p-dropdown [id]="'effect-damageType-' + i" [options]="damageTypes" formControlName="damageType"></p-dropdown>
                </div>

                <div class="col-12 md:col-4 field" *ngIf="effectControl.get('type').value === 'MODIFIER'">
                  <label [for]="'effect-stat-' + i">Stat</label>
                  <p-dropdown [id]="'effect-stat-' + i" [options]="statsToBuff" formControlName="stat"></p-dropdown>
                </div>

                 <!-- Row 3: Condition and Remove Button -->
                <div class="col-10 md:col-4 field">
                  <label [for]="'effect-condition-' + i">Condition</label>
                  <p-dropdown [id]="'effect-condition-' + i" [options]="conditionTypes" formControlName="condition" [showClear]="true"></p-dropdown>
                </div>
                <div class="col-2 md:col-1 field remove-button-container">
                  <button pButton type="button" icon="pi pi-trash" class="p-button-danger p-button-text" (click)="removeEffect(i)" pTooltip="Remove Effect"></button>
                </div>
              </div>
            </div>
          }
        </div>

        <button pButton type="button" label="Add Effect" icon="pi pi-plus" class="p-button-sm p-button-secondary mt-2" (click)="addEffect()"></button>
      </div>

    </div>
  </div>
</form>

<div class="p-dialog-footer">
  <button pButton type="button" label="Delete" class="p-button-danger" (click)="delete()"></button>
  <button pButton type="button" label="Cancel" class="p-button-text" (click)="close()"></button>
  <button pButton type="button" label="Save" class="p-button-success" (click)="save()" [disabled]="itemForm.invalid"></button>
</div>
