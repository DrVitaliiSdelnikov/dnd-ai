<div class="inventory-container">
  <div *ngIf="!inventoryItems?.length" class="empty-inventory">
    Inventory is empty.
  </div>

  <div *ngFor="let categoryName of objectKeys(categorizedItems)" class="inventory-section">
    <h3>{{ categoryName }}</h3>
    <ul class="item-list">
      <li *ngFor="let item of categorizedItems[categoryName]" class="item-entry">
        <div class="item-top-line">
          <div class="item-info">
            <span class="item-name">
              {{ item.name }}
              <span *ngIf="item.quantity > 1" class="item-quantity"> (x{{ item.quantity }})</span>
              <button
                type="button"
                class="equipped-badge toggle-equip"
                [ngClass]="{ 'equipped': isItemEquipped(item), 'unequipped': !isItemEquipped(item) }"
                (click)="toggleEquip(item)"
                [attr.aria-pressed]="isItemEquipped(item)"
                [pTooltip]="isItemEquipped(item) ? 'Click to unequip' : 'Click to equip'">
                {{ isItemEquipped(item) ? 'Equipped' : 'Equip' }}
              </button>
            </span>
            
            <span *ngIf="item.description">
              <i class="pi pi-info-circle" [pTooltip]="item.description" tooltipPosition="right"></i>
            </span>
          </div>
          <div class="item-actions">
            <button
              pButton
              type="button"
              class="p-button-text p-button-sm edit-button"
              (click)="openEditModal(item)"
              pTooltip="Edit Item">
              <i class="pi pi-pencil"></i>
            </button>

            <!-- Removed separate Equip/Unequip button; toggle handled by the pill above -->

            <button
              *ngIf="item.type === 'WEAPON' && item.properties?.effects"
              (click)="rollAttackAndDamage(item)"
              pButton
              (contextmenu)="callModeDialog(item, $event)"
              class="action-button attack-button p-button-danger p-button-outlined">
              Attack
            </button>
            <button
              *ngIf="item.type === 'CONSUMABLE' && item.properties.effect_details"
              (click)="useConsumable(item)"
              pButton
              class="action-button use-button p-button-success p-button-outlined">
              Use
            </button>

            <span *ngIf="damageRollResults[item.item_id_suggestion] === null" class="roll-result error">
               Roll error
            </span>
          </div>
        </div>

        <!-- Charges rows (below action buttons) -->
        <div *ngFor="let eff of getChargesEffects(item)" class="charges-row">
          <div class="charges-label">
            {{ chargesLabel(eff) }}
            <i *ngIf="chargesInfo(eff)" class="pi pi-info-circle ml-1" [pTooltip]="chargesInfo(eff)" tooltipPosition="right"></i>
          </div>
          <div class="charges-control" *ngIf="chargesUiMode(item, eff) === 'checkboxes'">
            <ng-container *ngFor="let idx of range(maxCharges(item, eff)); let i = index">
              <p-checkbox [binary]="true"
                          [ngModel]="i < getChargesUsed(eff)"
                          (onChange)="onChargesCheckboxClick(item, eff, i + 1)"></p-checkbox>
            </ng-container>
          </div>
          <div class="charges-control" *ngIf="chargesUiMode(item, eff) === 'counter'">
            <button pButton class="p-button-text p-button-sm" (click)="onChargesCounterAdjust(item, eff, -1)">-</button>
            <span class="mx-2">{{ getChargesUsed(eff) }} / {{ computeMaxCharges(item, eff) }}</span>
            <button pButton class="p-button-text p-button-sm" (click)="onChargesCounterAdjust(item, eff, 1)">+</button>
          </div>
          <div class="charges-control" *ngIf="chargesUiMode(item, eff) === 'none'">
            <span class="mx-2">Unlimited</span>
          </div>
        </div>
      </li>
    </ul>
  </div>

  <div class="add-item-fab">
    <p-speedDial [model]="itemAddOptions" direction="up" styleClass="p-speeddial-action-text" />
  </div>
</div>

<p-confirmpopup>
  <ng-template #content let-message>
    <app-roll-options-panel
      [includeNormal]="false"
      [toggles]="itemExtraToggles()"
      (toggleChanged)="onItemExtraToggleChanged($event)"
      (rollEmit)="rollAttackAndDamage(this.selectedItem(), $event)">
    </app-roll-options-panel>
  </ng-template>
</p-confirmpopup>

